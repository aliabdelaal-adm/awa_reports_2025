<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>قالب التقرير الاحترافي - خطة التفتيش الشهرية</title>
  <!-- External libraries will be loaded dynamically when needed -->
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Arial, Helvetica, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; 
      padding: 20px;
      direction: rtl;
    }
    
    .report-container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: #fff; 
      border-radius: 15px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
      overflow: hidden;
    }
    
    .header-section {
      background: linear-gradient(135deg, #2336a0 0%, #1e2a8a 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }
    
    .header-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" patternUnits="userSpaceOnUse" width="100" height="100"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    }
    
    .header-content {
      position: relative;
      z-index: 1;
    }
    
    .main-title {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
      margin-bottom: 20px;
    }
    
    .report-date {
      background: rgba(255,255,255,0.2);
      padding: 10px 20px;
      border-radius: 25px;
      display: inline-block;
      font-weight: bold;
    }
    
    .content-section {
      padding: 40px;
    }
    
    .section-header {
      background: linear-gradient(135deg, #e2e6f6 0%, #f0f2ff 100%);
      color: #2336a0;
      font-size: 1.4em;
      font-weight: bold;
      padding: 15px 25px;
      margin: 30px 0 20px 0;
      border-radius: 10px;
      border-left: 5px solid #2336a0;
      box-shadow: 0 2px 10px rgba(35, 54, 160, 0.1);
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }
    
    .data-card {
      background: #f8f9ff;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #e2e6f6;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }
    
    .data-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .card-title {
      color: #2336a0;
      font-weight: bold;
      font-size: 1.2em;
      margin-bottom: 15px;
      border-bottom: 2px solid #2336a0;
      padding-bottom: 8px;
    }
    
    .professional-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .professional-table th {
      background: linear-gradient(135deg, #2336a0 0%, #1e2a8a 100%);
      color: white;
      padding: 15px 10px;
      text-align: center;
      font-weight: bold;
      position: relative;
    }
    
    .professional-table th::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent 0%, white 50%, transparent 100%);
    }
    
    .professional-table td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #e2e6f6;
      transition: background-color 0.3s ease;
    }
    
    .professional-table tbody tr:hover {
      background-color: #f0f2ff;
    }
    
    .professional-table tbody tr:nth-child(even) {
      background-color: #fafbff;
    }
    
    .stats-section {
      background: linear-gradient(135deg, #f8f9ff 0%, #e2e6f6 100%);
      padding: 30px;
      border-radius: 15px;
      margin: 30px 0;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stat-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      color: #2336a0;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9em;
    }
    
    .export-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      padding: 30px;
      background: #f8f9ff;
      border-radius: 15px;
      margin: 30px 0;
    }
    
    .export-btn {
      background: linear-gradient(135deg, #2336a0 0%, #1e2a8a 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(35, 54, 160, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .export-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .export-btn:hover::before {
      left: 100%;
    }
    
    .export-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(35, 54, 160, 0.4);
    }
    
    .export-btn.powerpoint {
      background: linear-gradient(135deg, #d83b01 0%, #c13100 100%);
      box-shadow: 0 4px 15px rgba(216, 59, 1, 0.3);
    }
    
    .export-btn.excel {
      background: linear-gradient(135deg, #217346 0%, #1e5f3a 100%);
      box-shadow: 0 4px 15px rgba(33, 115, 70, 0.3);
    }
    
    .export-btn.word {
      background: linear-gradient(135deg, #2b579a 0%, #1f4788 100%);
      box-shadow: 0 4px 15px rgba(43, 87, 154, 0.3);
    }
    
    .chart-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      margin: 30px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .loading {
      text-align: center;
      color: #2336a0;
      font-weight: bold;
      padding: 20px;
    }
    
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
    }
    
    @media print {
      body { background: white; }
      .export-buttons { display: none; }
      .report-container { box-shadow: none; }
    }
    
    @media (max-width: 768px) {
      .data-grid { grid-template-columns: 1fr; }
      .export-buttons { flex-direction: column; align-items: center; }
      .main-title { font-size: 2em; }
      .content-section { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="report-container">
    <div class="header-section">
      <div class="header-content">
        <div class="main-title">تقرير خطة التفتيش الشهرية</div>
        <div class="subtitle">تقرير احترافي شامل لأنشطة التفتيش</div>
        <div class="report-date" id="reportDate"></div>
      </div>
    </div>
    
    <div class="content-section">
      <div class="export-buttons">
        <button class="export-btn powerpoint" onclick="exportToPowerPoint()">
          📊 تصدير PowerPoint
        </button>
        <button class="export-btn excel" onclick="exportToExcel()">
          📈 تصدير Excel
        </button>
        <button class="export-btn word" onclick="exportToWord()">
          📄 تصدير Word
        </button>
        <button class="export-btn" onclick="exportToPDF()">
          📋 تصدير PDF
        </button>
        <button class="export-btn" onclick="window.print()">
          🖨️ طباعة
        </button>
      </div>
      
      <div id="loadingMessage" class="loading" style="display: none;">
        جاري تحضير التقرير الاحترافي...
      </div>
      
      <div id="successMessage" class="success-message" style="display: none;"></div>
      
      <div class="section-header">📋 معلومات عامة عن الخطة</div>
      <div class="data-grid">
        <div class="data-card">
          <div class="card-title">أهداف التفتيش</div>
          <div id="goalsContent"></div>
        </div>
        <div class="data-card">
          <div class="card-title">معلومات التقرير</div>
          <div>
            <strong>تاريخ إنشاء التقرير:</strong> <span id="creationDate"></span><br>
            <strong>عدد المفتشين:</strong> <span id="inspectorCount"></span><br>
            <strong>عدد المناطق:</strong> <span id="areaCount"></span><br>
            <strong>إجمالي المحلات:</strong> <span id="totalShops"></span>
          </div>
        </div>
      </div>
      
      <div class="section-header">👥 قائمة المفتشين</div>
      <div id="inspectorsList"></div>
      
      <div class="section-header">🗺️ المناطق والمحلات</div>
      <div id="areasAndShops"></div>
      
      <div class="section-header">📅 جدول التفتيش التفصيلي</div>
      <div id="inspectionTable"></div>
      
      <div class="section-header">📊 الإحصائيات والتحليلات</div>
      <div class="stats-section">
        <div class="stats-grid" id="statsGrid"></div>
        <div class="chart-container">
          <canvas id="inspectionChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    let inspectionData = {
      inspectors: [],
      areas: [],
      shopsByArea: {},
      distribution: [],
      goals: ""
    };

    // Load data from local storage or use demo data
    function loadInspectionData() {
      try {
        // Try to get data from localStorage first (from main app)
        const localData = localStorage.getItem('inspectionPlanData');
        if (localData) {
          inspectionData = JSON.parse(localData);
        } else {
          // Use demo data for demonstration
          inspectionData = {
            inspectors: [
              "د. علي عبدالعال", 
              "د. محمد إسماعيل", 
              "د. فايز المسالمة",
              "د. محمد سعيد",
              "د. آيه سلامة",
              "د. آمنه بن صرم"
            ],
            areas: ["سوق الطيور", "مركز المدينة", "الوثبة جنوب", "مدينة محمد بن زايد", "مدينة خليفة"],
            shopsByArea: {
              "سوق الطيور": ["محل الياقوت", "محل زون تايم", "محل الميناء"],
              "مركز المدينة": ["محل المركز الأول", "محل المركز الثاني", "محل المركز الثالث"],
              "الوثبة جنوب": ["محل الوثبة الأول", "محل الوثبة الثاني"],
              "مدينة محمد بن زايد": ["محل MBZ الأول", "محل MBZ الثاني"],
              "مدينة خليفة": ["محل خليفة الأول"]
            },
            distribution: [
              {
                inspector: "د. علي عبدالعال",
                day: "2025-01-15",
                shift: "مسائية",
                area: "سوق الطيور",
                shops: ["محل الياقوت", "محل زون تايم"]
              },
              {
                inspector: "د. محمد إسماعيل",
                day: "2025-01-16",
                shift: "صباحية",
                area: "مركز المدينة",
                shops: ["محل المركز الأول", "محل المركز الثاني"]
              },
              {
                inspector: "د. فايز المسالمة",
                day: "2025-01-17",
                shift: "مسائية",
                area: "الوثبة جنوب",
                shops: ["محل الوثبة الأول"]
              },
              {
                inspector: "د. محمد سعيد",
                day: "2025-01-18",
                shift: "صباحية",
                area: "مدينة محمد بن زايد",
                shops: ["محل MBZ الأول", "محل MBZ الثاني"]
              },
              {
                inspector: "د. آيه سلامة",
                day: "2025-01-19",
                shift: "مسائية",
                area: "مدينة خليفة",
                shops: ["محل خليفة الأول"]
              }
            ],
            goals: "ضمان سلامة المنتجات والالتزام بالاشتراطات الصحية وحماية المستهلكين"
          };
        }
        renderReport();
      } catch (error) {
        console.error('Error loading data:', error);
        renderReport();
      }
    }

    function renderReport() {
      // Set report date
      document.getElementById('reportDate').textContent = new Intl.DateTimeFormat('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      }).format(new Date());

      document.getElementById('creationDate').textContent = new Date().toLocaleDateString('ar-SA');
      
      // Basic info
      document.getElementById('goalsContent').textContent = inspectionData.goals || "لم يتم تحديد أهداف";
      document.getElementById('inspectorCount').textContent = inspectionData.inspectors.length;
      document.getElementById('areaCount').textContent = inspectionData.areas.length;
      
      let totalShops = 0;
      Object.values(inspectionData.shopsByArea).forEach(shops => totalShops += shops.length);
      document.getElementById('totalShops').textContent = totalShops;

      // Render inspectors list
      renderInspectorsList();
      
      // Render areas and shops
      renderAreasAndShops();
      
      // Render inspection table
      renderInspectionTable();
      
      // Render statistics
      renderStatistics();
      
      // Render chart
      renderChart();
    }

    function renderInspectorsList() {
      const container = document.getElementById('inspectorsList');
      let html = '<div class="data-grid">';
      
      inspectionData.inspectors.forEach((inspector, index) => {
        const inspectorTasks = inspectionData.distribution.filter(d => d.inspector === inspector);
        html += `
          <div class="data-card">
            <div class="card-title">${inspector}</div>
            <div>عدد المهام: ${inspectorTasks.length}</div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    function renderAreasAndShops() {
      const container = document.getElementById('areasAndShops');
      let html = '<table class="professional-table"><thead><tr>';
      html += '<th>المنطقة</th><th>عدد المحلات</th><th>أسماء المحلات</th></tr></thead><tbody>';
      
      inspectionData.areas.forEach(area => {
        const shops = inspectionData.shopsByArea[area] || [];
        html += `
          <tr>
            <td><strong>${area}</strong></td>
            <td>${shops.length}</td>
            <td>${shops.join(', ') || 'لا توجد محلات'}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function renderInspectionTable() {
      const container = document.getElementById('inspectionTable');
      let html = '<table class="professional-table"><thead><tr>';
      html += '<th>المفتش</th><th>التاريخ</th><th>المناوبة</th><th>المنطقة</th><th>المحلات</th></tr></thead><tbody>';
      
      inspectionData.distribution.forEach(item => {
        const formattedDate = new Date(item.day).toLocaleDateString('ar-SA');
        const shops = Array.isArray(item.shops) ? item.shops.join(', ') : item.shops || '';
        html += `
          <tr>
            <td><strong>${item.inspector}</strong></td>
            <td>${formattedDate}</td>
            <td>${item.shift}</td>
            <td>${item.area}</td>
            <td>${shops}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function renderStatistics() {
      const container = document.getElementById('statsGrid');
      
      // Calculate statistics
      const inspectorStats = {};
      const areaStats = {};
      const shiftStats = { 'صباحية': 0, 'مسائية': 0 };
      
      inspectionData.distribution.forEach(item => {
        inspectorStats[item.inspector] = (inspectorStats[item.inspector] || 0) + 1;
        areaStats[item.area] = (areaStats[item.area] || 0) + 1;
        shiftStats[item.shift] = (shiftStats[item.shift] || 0) + 1;
      });
      
      let html = `
        <div class="stat-item">
          <div class="stat-number">${inspectionData.distribution.length}</div>
          <div class="stat-label">إجمالي مهام التفتيش</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${shiftStats['صباحية']}</div>
          <div class="stat-label">المناوبات الصباحية</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${shiftStats['مسائية']}</div>
          <div class="stat-label">المناوبات المسائية</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${Object.keys(inspectorStats).length}</div>
          <div class="stat-label">المفتشين النشطين</div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function renderChart() {
      const container = document.getElementById('inspectionChart');
      const ctx = container.getContext('2d');
      
      // Create a simple chart with basic canvas drawing since Chart.js might not load
      ctx.fillStyle = '#2336a0';
      ctx.fillRect(50, 50, 100, 100);
      ctx.fillStyle = 'white';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('الرسم البياني', 100, 105);
      ctx.fillStyle = '#666';
      ctx.font = '12px Arial';
      ctx.fillText('(سيتم تحسينه في النسخة النهائية)', 100, 125);
      
      // Try to load Chart.js dynamically for better charts
      if (typeof Chart !== 'undefined') {
        // Prepare data for chart
        const inspectorStats = {};
        inspectionData.distribution.forEach(item => {
          inspectorStats[item.inspector] = (inspectorStats[item.inspector] || 0) + 1;
        });
        
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(inspectorStats),
            datasets: [{
              label: 'عدد مهام التفتيش',
              data: Object.values(inspectorStats),
              backgroundColor: 'rgba(35, 54, 160, 0.8)',
              borderColor: 'rgba(35, 54, 160, 1)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'توزيع مهام التفتيش على المفتشين'
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }

    function showLoading() {
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
    }

    function showSuccess(message) {
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'block';
      document.getElementById('successMessage').textContent = message;
      setTimeout(() => {
        document.getElementById('successMessage').style.display = 'none';
      }, 3000);
    }

    // PowerPoint Export (creates an HTML file that can be opened in PowerPoint)
    function exportToPowerPoint() {
      showLoading();
      
      try {
        const content = generatePowerPointHTML();
        const blob = new Blob([content], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'تقرير_خطة_التفتيش_الاحترافي.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showSuccess('تم تصدير التقرير! يمكنك فتح الملف وحفظه كـ PowerPoint من خلال برنامج العروض التقديمية.');
        
      } catch (error) {
        console.error('PowerPoint export error:', error);
        showSuccess('حدث خطأ في التصدير. يرجى المحاولة مرة أخرى.');
      }
    }

    function generatePowerPointHTML() {
      return `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
          <meta charset="UTF-8">
          <title>تقرير خطة التفتيش الشهرية</title>
          <style>
            body { font-family: Arial, sans-serif; direction: rtl; margin: 0; padding: 20px; }
            .slide { page-break-after: always; min-height: 500px; padding: 40px; margin-bottom: 50px; border: 2px solid #2336a0; }
            .slide-header { background: #2336a0; color: white; padding: 20px; margin: -40px -40px 20px -40px; text-align: center; }
            .slide-title { font-size: 2em; margin-bottom: 10px; }
            .slide-subtitle { font-size: 1.2em; opacity: 0.9; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #2336a0; padding: 10px; text-align: center; }
            th { background: #2336a0; color: white; }
            .chart-placeholder { background: #f0f0f0; height: 200px; display: flex; align-items: center; justify-content: center; margin: 20px 0; border: 2px dashed #2336a0; }
          </style>
        </head>
        <body>
          <div class="slide">
            <div class="slide-header">
              <div class="slide-title">تقرير خطة التفتيش الشهرية</div>
              <div class="slide-subtitle">تقرير احترافي شامل لأنشطة التفتيش</div>
              <div>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</div>
            </div>
            <div style="text-align: center; font-size: 1.5em; margin-top: 50px;">
              <p><strong>أهداف التفتيش:</strong></p>
              <p style="color: #2336a0; font-size: 1.2em;">${inspectionData.goals}</p>
            </div>
          </div>

          <div class="slide">
            <div class="slide-header">
              <div class="slide-title">نظرة عامة على الخطة</div>
            </div>
            <table>
              <tr><th>المؤشر</th><th>القيمة</th></tr>
              <tr><td>عدد المفتشين</td><td>${inspectionData.inspectors.length}</td></tr>
              <tr><td>عدد المناطق</td><td>${inspectionData.areas.length}</td></tr>
              <tr><td>إجمالي المحلات</td><td>${Object.values(inspectionData.shopsByArea).reduce((sum, shops) => sum + shops.length, 0)}</td></tr>
              <tr><td>إجمالي مهام التفتيش</td><td>${inspectionData.distribution.length}</td></tr>
            </table>
          </div>

          <div class="slide">
            <div class="slide-header">
              <div class="slide-title">قائمة المفتشين</div>
            </div>
            <table>
              <tr><th>المفتش</th><th>عدد المهام</th></tr>
              ${inspectionData.inspectors.map(inspector => {
                const taskCount = inspectionData.distribution.filter(d => d.inspector === inspector).length;
                return `<tr><td>${inspector}</td><td>${taskCount}</td></tr>`;
              }).join('')}
            </table>
          </div>

          <div class="slide">
            <div class="slide-header">
              <div class="slide-title">جدول التفتيش التفصيلي</div>
            </div>
            <table>
              <tr><th>المفتش</th><th>التاريخ</th><th>المناوبة</th><th>المنطقة</th></tr>
              ${inspectionData.distribution.map(item => `
                <tr>
                  <td>${item.inspector}</td>
                  <td>${new Date(item.day).toLocaleDateString('ar-SA')}</td>
                  <td>${item.shift}</td>
                  <td>${item.area}</td>
                </tr>
              `).join('')}
            </table>
          </div>

          <div class="slide">
            <div class="slide-header">
              <div class="slide-title">الإحصائيات والمؤشرات</div>
            </div>
            <div class="chart-placeholder">
              <div style="text-align: center;">
                <h3>إحصائيات التفتيش</h3>
                <p>المناوبات الصباحية: ${inspectionData.distribution.filter(d => d.shift === 'صباحية').length}</p>
                <p>المناوبات المسائية: ${inspectionData.distribution.filter(d => d.shift === 'مسائية').length}</p>
              </div>
            </div>
          </div>
        </body>
        </html>
      `;
    }

    // Excel Export (CSV format that can be opened in Excel)
    function exportToExcel() {
      showLoading();
      
      try {
        let csvContent = '\uFEFF'; // BOM for UTF-8
        csvContent += 'تقرير خطة التفتيش الشهرية\n';
        csvContent += `تاريخ التقرير,${new Date().toLocaleDateString('ar-SA')}\n\n`;
        
        csvContent += 'معلومات عامة\n';
        csvContent += `عدد المفتشين,${inspectionData.inspectors.length}\n`;
        csvContent += `عدد المناطق,${inspectionData.areas.length}\n`;
        csvContent += `إجمالي المحلات,${Object.values(inspectionData.shopsByArea).reduce((sum, shops) => sum + shops.length, 0)}\n`;
        csvContent += `إجمالي مهام التفتيش,${inspectionData.distribution.length}\n\n`;
        
        csvContent += 'قائمة المفتشين ومهامهم\n';
        csvContent += 'المفتش,عدد المهام\n';
        inspectionData.inspectors.forEach(inspector => {
          const taskCount = inspectionData.distribution.filter(d => d.inspector === inspector).length;
          csvContent += `"${inspector}",${taskCount}\n`;
        });
        
        csvContent += '\nجدول التفتيش التفصيلي\n';
        csvContent += 'المفتش,التاريخ,المناوبة,المنطقة,المحلات\n';
        inspectionData.distribution.forEach(item => {
          const shops = Array.isArray(item.shops) ? item.shops.join('; ') : item.shops || '';
          csvContent += `"${item.inspector}","${new Date(item.day).toLocaleDateString('ar-SA')}","${item.shift}","${item.area}","${shops}"\n`;
        });

        const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'تقرير_خطة_التفتيش_الاحترافي.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showSuccess('تم تصدير التقرير إلى Excel بنجاح! (ملف CSV)');
        
      } catch (error) {
        console.error('Excel export error:', error);
        showSuccess('حدث خطأ في التصدير. يرجى المحاولة مرة أخرى.');
      }
    }

    // Word Export (HTML format compatible with Word)
    function exportToWord() {
      showLoading();
      
      try {
        let htmlContent = `
          <!DOCTYPE html>
          <html dir="rtl">
          <head>
            <meta charset="UTF-8">
            <title>تقرير خطة التفتيش الشهرية</title>
            <style>
              body { font-family: Arial, sans-serif; direction: rtl; }
              .header { background: #2336a0; color: white; padding: 20px; text-align: center; }
              .section { margin: 20px 0; }
              .section-title { background: #e2e6f6; padding: 10px; font-weight: bold; color: #2336a0; }
              table { width: 100%; border-collapse: collapse; margin: 10px 0; }
              th, td { border: 1px solid #ccc; padding: 8px; text-align: right; }
              th { background: #2336a0; color: white; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>تقرير خطة التفتيش الشهرية</h1>
              <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
            </div>
            
            <div class="section">
              <div class="section-title">معلومات عامة</div>
              <p><strong>أهداف التفتيش:</strong> ${inspectionData.goals}</p>
              <p><strong>عدد المفتشين:</strong> ${inspectionData.inspectors.length}</p>
              <p><strong>عدد المناطق:</strong> ${inspectionData.areas.length}</p>
            </div>
            
            <div class="section">
              <div class="section-title">جدول التفتيش</div>
              <table>
                <thead>
                  <tr><th>المفتش</th><th>التاريخ</th><th>المناوبة</th><th>المنطقة</th></tr>
                </thead>
                <tbody>
        `;
        
        inspectionData.distribution.forEach(item => {
          htmlContent += `
            <tr>
              <td>${item.inspector}</td>
              <td>${new Date(item.day).toLocaleDateString('ar-SA')}</td>
              <td>${item.shift}</td>
              <td>${item.area}</td>
            </tr>
          `;
        });
        
        htmlContent += `
                </tbody>
              </table>
            </div>
          </body>
          </html>
        `;

        const blob = new Blob([htmlContent], {type: 'application/msword'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'تقرير_خطة_التفتيش_الاحترافي.doc';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showSuccess('تم تصدير التقرير إلى Word بنجاح!');
        
      } catch (error) {
        console.error('Word export error:', error);
        showSuccess('حدث خطأ في التصدير. يرجى المحاولة مرة أخرى.');
      }
    }

    // PDF Export (simplified version)
    function exportToPDF() {
      showLoading();
      
      try {
        // Create a clean version for PDF
        const printContent = document.querySelector('.report-container').cloneNode(true);
        const exportButtons = printContent.querySelector('.export-buttons');
        if (exportButtons) exportButtons.remove();
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html dir="rtl">
          <head>
            <meta charset="UTF-8">
            <title>تقرير خطة التفتيش الشهرية</title>
            <style>
              body { font-family: Arial, sans-serif; direction: rtl; margin: 20px; }
              .report-container { max-width: 100%; }
              .header-section { background: #2336a0; color: white; padding: 20px; text-align: center; margin-bottom: 20px; }
              .section-header { background: #e2e6f6; color: #2336a0; font-weight: bold; padding: 10px; margin: 20px 0 10px 0; }
              table { width: 100%; border-collapse: collapse; margin: 10px 0; }
              th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
              th { background: #2336a0; color: white; }
              .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
              .data-card { background: #f8f9ff; padding: 15px; border: 1px solid #e2e6f6; margin: 10px 0; }
              .card-title { font-weight: bold; color: #2336a0; margin-bottom: 10px; }
              @media print { body { margin: 0; } }
            </style>
          </head>
          <body>
            ${printContent.outerHTML}
          </body>
          </html>
        `);
        printWindow.document.close();
        
        setTimeout(() => {
          printWindow.print();
          showSuccess('تم فتح نافذة الطباعة! يمكنك حفظ التقرير كـ PDF من خيارات الطباعة.');
        }, 1000);
        
      } catch (error) {
        console.error('PDF export error:', error);
        showSuccess('حدث خطأ في التصدير. يرجى المحاولة مرة أخرى.');
      }
    }

    // Initialize
    loadInspectionData();
  </script>
</body>
</html>